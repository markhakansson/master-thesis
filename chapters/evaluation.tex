This chapter will describe what methods have been used to evaluate the
implementation in the previous chapter to determine whether it can solve the
problem defintion or not. The results from the evaluation will be discussed in
the next chapter.

\section{Test configuration}
\begin{itemize}
    \item Target hardware: STM32 Nucleo-64 Development Board
    \begin{itemize}
       \item MCU clock at 8 MHz
    \end{itemize}
    \item Rust compiler version 1.51, stable release channel
\end{itemize}

\section{Test application}
The test application to test RAUK's functionality on, is an RTIC application
that toggles an LED on and off for a specified interval on the development board. In
addition there is a button that can be pressed by the user to interrupt the
LED. Both the LED functionality and the button functionality have been
implemented as two separate tasks, which are the only user tasks in the
application. The tasks also share some resources between each other in order to
demonstrate blocking and preemption. The button task have the higher priority
and will interrupt the LED task whenever the button is pressed.

For demonstration purposes both tasks calls the Cortex-M specific
\texttt{delay} function inside different conditional branches. This function
will try to stall the core for the specified cycles. Which will be useful to
see if all paths have been hit by KLEE and that RAUK have measured it correctly.
The function does not delay for the exact given cycles and can sometimes delay
for twice the specified cycles.

The application code for the tasks to be tested can be seen in Listing
\ref{lst:evalbutton} and \ref{lst:evaltoggle}. No deep understanding is
needed for the Rust language. The only important thing to note is the
conditional branches in the code.
\lstinputlisting[
    language={rust},
    %float=h,
    caption={Aperiodic task executed whenever the button is pressed.},
    label={lst:evalbutton},
]{../code/button_click.rs}

\lstinputlisting[
    language={rust},
    %float=h,
    caption={Periodic task that toggles the LED on and off.},
    label={lst:evaltoggle},
]{../code/toggle_led.rs}

\section{Execution time measurement results}
RAUK has been tested on the test application built with and without release
optimizations. The release flag on the Rust package manager will enable all
optimizations during compilation of the application which may greatly improve
performance and size of the created binary.

The measured execution time (ET) using RAUK will be shown together with the
actual ET. Which has been measured manually from the generated test vectors,
using the GNU debugger on the original application binary compiled without
using RAUK or its custom forks

For no optimizations, one of the test vectors generated would result in an
error and the program crashing. Which can be seen in Table \ref{tab:evaldebugtestsbuttonerror}.

\subsection{No compiler optimizations}
The test vectors generated by KLEE via the RAUK tool without optimizations can
be seen in Table \ref{tab:evaldebugtestsbutton} for the button task and in
Table \ref{tab:evaldebugteststoggle}. The result from measuring the execution
time for the test vectors are displayed in Table \ref{tab:evaldebugmeasure}.


\begin{longtable}{|c|c|c|c|}
\hline
Error no. & Task name & Resource name & Value (as integer) \\ \hline
\multirow{3}{*}{1} & \multirow{3}{*}{\texttt{button\_click}} & \texttt{shared\_u8}  & 255 \\ \cline{3-4}
                   &                                         & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                         & \texttt{dwt}         & 0 \\ \hline
\caption{Test vectors generated by KLEE which results in errors without any optimizations}
\label{tab:evaldebugtestsbuttonerror}
\end{longtable}

\begin{longtable}{|c|c|c|c|}
\hline
Test no. & Task name & Resource name & Value (as integer) \\ \hline
\multirow{3}{*}{1} & \multirow{3}{*}{\texttt{button\_click}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                         & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                         & \texttt{dwt}         & 0 \\ \hline
\multirow{3}{*}{2} & \multirow{3}{*}{\texttt{button\_click}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                         & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                         & \texttt{dwt}         & 123456789 \\ \hline
\caption{KLEE generated test vectors for the \texttt{button\_click} task without any optimizations.}
\label{tab:evaldebugtestsbutton}
\end{longtable}

\begin{longtable}{|c|c|c|c|}
\hline
Test no. & Task name & Resource name & Value (as integer) \\ \hline
\multirow{3}{*}{3} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 1 \\ \hline
\multirow{3}{*}{4} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 0 \\ \hline
\multirow{3}{*}{5} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 123 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 0 \\ \hline
\multirow{3}{*}{6} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 123 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 1 \\ \hline
\multirow{3}{*}{7} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 123 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 12345 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 0 \\ \hline
\multirow{3}{*}{8} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 123 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 12345 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}      & 1 \\ \hline
\caption{KLEE generated test vectors for the \texttt{toggle\_led} task without any optimizations.}
\label{tab:evaldebugteststoggle}
\end{longtable}

\begin{longtable}{|c | c | c | c|}
    \hline
    Test no. & Task name & Measured ET (cycles) & Actual ET (cycles) \\ [0.5ex]
    \hline
    1 & \texttt{button\_click} & 625 & 248 \\
    \hline
    2 & \texttt{button\_click} & 15 650 & 15 274 \\
    \hline
    3 & \texttt{toggle\_led} & 1399 & 999  \\
    \hline
    4 & \texttt{toggle\_led} & 1401  & 1002 \\
    \hline
    5 & \texttt{toggle\_led} & 2929  & 2532 \\
    \hline
    6 & \texttt{toggle\_led} & 2930 & 2529 \\
    \hline
    7 & \texttt{toggle\_led} & 17 972 & 17 575 \\
    \hline
    8 & \texttt{toggle\_led} & 17 973 & 17 572 \\
    \hline
\caption{Measured execution times (ET) in clock cycles for the test application without any optimizations, from the generated test vectors.}
\label{tab:evaldebugmeasure}
\end{longtable}

\subsection{Release optimization}

\begin{longtable}{|c|c|c|c|}
\hline
Test no. & Task name & Resource name & Value (as integer) \\ \hline
\multirow{3}{*}{1} & \multirow{3}{*}{\texttt{button\_click}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                         & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                         & \texttt{dwt}         & 0 \\ \hline
\caption{KLEE generated test vectors for the \texttt{button\_click} task with release optimizations.}
\label{tab:evalreleasetestsbutton}
\end{longtable}

\begin{longtable}{|c|c|c|c|}
\hline
Test no. & Task name & Resource name & Value (as integer) \\ \hline
\multirow{3}{*}{2} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 123 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 12345 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 0 \\ \hline
\multirow{3}{*}{3} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 0 \\ \hline
\multirow{3}{*}{4} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 123 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 12345 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 1 \\ \hline
\multirow{3}{*}{5} & \multirow{3}{*}{\texttt{toggle\_led}} & \texttt{shared\_u8}  & 0 \\ \cline{3-4}
                   &                                       & \texttt{shared\_u16} & 0 \\ \cline{3-4}
                   &                                       & \texttt{led\_on}     & 255 \\ \hline
\caption{KLEE generated test vectors for the \texttt{toggle\_led} task with release optimizations.}
\label{tab:evalreleaseteststoggle}
\end{longtable}

\begin{longtable}{|c | c | c | c|}
    \hline
    Test no. & Task name & Measured ET (cycles) & Actual ET (cycles) \\ [0.5ex]
    \hline
    1 & \texttt{button\_click} & 263 & 26 \\
    \hline
    2 & \texttt{toggle\_led} & 16 939 & 16 568 \\
    \hline
    3 & \texttt{toggle\_led} & 405 & 36 \\
    \hline
    4 & \texttt{toggle\_led} & 16 934 & 16 567 \\
    \hline
    5 & \texttt{toggle\_led} & 403 & 24 \\
    \hline
\caption{Measured execution times (ET) in clock cycles for the test application without any optimizations, from the generated test vectors.}
\label{tab:evalreleasemeasure}
\end{longtable}

\section{Schedulability analysis results}
In Table \ref{tab:evalschedtasks} an example of the expected deadlines and
periods for each task are given. The system will be tested for its
schedulability when the LED toggles each second and the button is expected to
be pressed at most eight times a second. Since the development board is clocked
at 8 MHz this is equivalent to 8 000 000 and 1 000 000 cycles respectively. The
deadlines for both tasks are set at 200 000 cycles. Which was chosen
arbitrarily.

\begin{longtable}{|c | c | c|}
    \hline
     & \texttt{button\_click} & \texttt{toggle\_led} \\
    \hline
    Priority & 2 & 1 \\
    \hline
    Relative deadline (cycles) & 200 000 & 200 000 \\
    \hline
    Period/ inter-arrival time (cycles) & 1 000 000 & 8 000 000 \\
    \hline
\caption{Values for the tasks for schedulability analysis.}
\label{tab:evalschedtasks}
\end{longtable}

In the following subsections preemption time refers to the time that
a task can be interrupted by a higher priority task.

\subsection{No compiler optimizations}
The schedulability analysis results without any optimizations can be seen in
Table \ref{tab:evalscheddebug}.

Note that the WCET in Table \ref{tab:evalscheddebug} for both tasks given as input
to the schedulability analysis are a few cycles different from the worst measure
ET in Table \ref{tab:evaldebugmeasure}, when they should be the same.

\begin{longtable}{|c | c | c|}
    \hline
     & \texttt{button\_click} & \texttt{toggle\_led} \\
    \hline
    WCRT (cycles) & 33 044 & 33 630 \\
    \hline
    WCET (cycles) & 15 651 & 17 979 \\
    \hline
    Blocking time (cycles) & 17 393 & 0 \\
    \hline
    Preemption time (cycles) & 0 & 15 651 \\
    \hline
    Worst-case system load & 1.57\% & 0.22\% \\
    \hline
\caption{Schedulability results for no optimizations.}
\label{tab:evalscheddebug}
\end{longtable}

\subsection{Release optimizations}
\begin{longtable}{|c | c | c|}
    \hline
     & \texttt{button\_click} & \texttt{toggle\_led} \\
    \hline
    WCRT (cycles) & 16 932 & 17 202 \\
    \hline
    WCET (cycles) & 263 & 16 939 \\
    \hline
    Blocking time (cycles) & 16 669 & 0 \\
    \hline
    Preemption time (cycles) & 0 & 263 \\
    \hline
    Worst-case system load (cycles) & 0.03\% & 0.21\% \\
    \hline
\caption{Schedulability results for release optimizations.}
\label{tab:evalschedrelease}
\end{longtable}
